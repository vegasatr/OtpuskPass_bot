# Инструкция по деплою на Railway

## Подготовка

1. Убедитесь, что все файлы закоммичены в Git
2. Создайте аккаунт на [Railway](https://railway.app)

## Деплой

### Вариант 1: Через GitHub (рекомендуется)

1. Подключите ваш GitHub репозиторий к Railway
2. Railway автоматически обнаружит проект и начнет сборку
3. Настройте переменные окружения (см. ниже)

### Вариант 2: Через Railway CLI

```bash
# Установите Railway CLI
npm i -g @railway/cli

# Войдите в аккаунт
railway login

# Инициализируйте проект
railway init

# Деплой
railway up
```

## Настройка переменных окружения

В панели Railway добавьте следующие переменные окружения:

### Обязательные переменные:

- `BOT_TOKEN` - токен Telegram бота (получите у @BotFather)
- `DATABASE_URL` - URL подключения к MySQL (см. раздел "Настройка базы данных")

### Опциональные переменные:

- `TON_API_KEY` - API ключ для TON Center
- `TON_WALLET_ADDRESS` - адрес кошелька TON
- `GEMINI_API_KEY` - API ключ для Google Gemini (если используется)

## Настройка базы данных

### База данных MySQL на Railway

Для подключения к базе данных MySQL на Railway используйте **внутреннюю ссылку**:

```
mysql://root:BOrEIPmqHsfNbORBbxJaUhFSTyekKjYJ@mysql.railway.internal:3306/railway
```

**Важно:** 
- Это внутренняя ссылка, доступная только внутри сети Railway
- Используйте эту ссылку для переменной окружения `DATABASE_URL`
- URL автоматически преобразуется в формат `mysql+pymysql://` для работы с SQLAlchemy
- База данных будет автоматически инициализирована при первом запуске через `start.py`

### Настройка DATABASE_URL

В панели Railway:
1. Перейдите в настройки вашего сервиса
2. Добавьте переменную окружения `DATABASE_URL`
3. Установите значение: `mysql://root:BOrEIPmqHsfNbORBbxJaUhFSTyekKjYJ@mysql.railway.internal:3306/railway`

## Настройка сервисов

### Вариант 1: Один сервис (бот + веб-приложение)

Railway автоматически запустит оба процесса через `start.py`.

### Вариант 2: Два отдельных сервиса

1. Создайте два сервиса в Railway:
   - **Сервис 1 (Бот)**: Используйте `Procfile` с процессом `bot`
   - **Сервис 2 (Веб-приложение)**: Используйте `Procfile` с процессом `webapp`

2. Для каждого сервиса настройте:
   - **Бот**: `RAILWAY_SERVICE_NAME=bot` или используйте команду `python -m src.main`
   - **Веб-приложение**: `RAILWAY_SERVICE_NAME=webapp` или используйте команду `uvicorn src.web.main:app --host 0.0.0.0 --port $PORT`

## Проверка деплоя

1. Проверьте логи в панели Railway
2. Убедитесь, что бот отвечает в Telegram
3. Проверьте веб-приложение по URL, предоставленному Railway

## Полезные команды

```bash
# Просмотр логов
railway logs

# Открыть оболочку в контейнере
railway shell

# Просмотр переменных окружения
railway variables
```

## Решение проблем

### Бот не запускается

- Проверьте, что `BOT_TOKEN` установлен правильно
- Проверьте логи на наличие ошибок
- Убедитесь, что база данных инициализирована
- Проверьте, что `DATABASE_URL` установлен с правильной внутренней ссылкой MySQL

### Веб-приложение не доступно

- Проверьте, что процесс `webapp` запущен
- Убедитесь, что переменная `PORT` установлена (Railway устанавливает её автоматически)
- Проверьте настройки CORS, если есть проблемы с доступом

### Ошибки подключения к базе данных

- Убедитесь, что используете **внутреннюю ссылку** MySQL (`mysql.railway.internal`)
- Проверьте, что база данных MySQL запущена в Railway
- Убедитесь, что переменная `DATABASE_URL` установлена правильно
- Проверьте логи на наличие ошибок подключения

### Ошибки импорта

- Убедитесь, что `PYTHONPATH` настроен правильно в `Railway.toml`
- Проверьте, что все зависимости установлены в `requirements.txt`

## Обновление

После каждого изменения в коде:

1. Закоммитьте изменения в Git
2. Railway автоматически пересоберет и перезапустит сервисы
3. Или используйте `railway up` для ручного деплоя

